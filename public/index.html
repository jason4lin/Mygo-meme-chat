<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyGO Meme Chat</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background: #f0f2f5;
      }
      #chat-container {
        height: 70vh;
        overflow-y: auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .message {
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 80%;
        line-height: 1.5;
      }
      .user-message {
        align-self: flex-end;
        background: #007bff;
        color: white;
      }
      .ai-message {
        align-self: flex-start;
        background: #e9ecef;
        color: black;
      }
      .meme-image {
        max-width: 100%;
        border-radius: 10px;
        margin-top: 5px;
        display: block;
      }
      #input-area {
        margin-top: 20px;
        display: flex;
        gap: 10px;
      }
      input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
      }
      button {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <h1>MyGO Meme Chat</h1>
    <div id="chat-container"></div>
    <div id="input-area">
      <input
        type="text"
        id="message-input"
        placeholder="Say something..."
        autofocus
      />
      <button id="send-btn">Send</button>
    </div>

    <!-- Import Google Generative AI SDK -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <script type="module">
      import { GoogleGenerativeAI } from "@google/generative-ai";

      const chatContainer = document.getElementById("chat-container");
      const messageInput = document.getElementById("message-input");
      const sendBtn = document.getElementById("send-btn");

      let MEME_DATABASE = [];
      let chatHistory = []; // Local history state

      // 1. Load Memes
      async function loadMemes() {
        try {
          const res = await fetch("memes.json");
          MEME_DATABASE = await res.json();
          console.log(`Loaded ${MEME_DATABASE.length} memes.`);
        } catch (e) {
          console.error("Failed to load memes.json", e);
          alert("Error: Could not load meme database.");
        }
      }
      loadMemes();

      // 2. API Key Management
      function getApiKey() {
        let key = localStorage.getItem("MYGO_API_KEY");
        if (!key) {
          key = prompt(
            "Please enter your Gemini API Key (It will be saved locally):"
          );
          if (key) {
            localStorage.setItem("MYGO_API_KEY", key);
          } else {
            alert("API Key is required to chat.");
          }
        }
        return key;
      }

      // Check on load
      let apiKey = getApiKey();

      async function sendMessage() {
        if (!apiKey) {
          apiKey = getApiKey();
          if (!apiKey) return;
        }

        const text = messageInput.value.trim();
        if (!text) return;

        // Add user message
        addMessage(text, "user");
        chatHistory.push({ role: "user", content: text });
        messageInput.value = "";

        // Create AI message placeholder
        const aiMessageDiv = addMessage("...", "ai");

        try {
          // Initialize GenAI
          const genAI = new GoogleGenerativeAI(apiKey);
          const model = genAI.getGenerativeModel({
            model: "gemini-2.0-flash",
            generationConfig: {
              temperature: 0.5,
              maxOutputTokens: 20,
            },
          });

          // Construct Prompt
          const historyText = chatHistory
            .slice(-5)
            .map((msg) => {
              const label = msg.role === "user" ? "User" : "Bot";
              return `${label}: ${msg.content}`;
            })
            .join("\n");

          const fullPrompt = `
    TASK: You are a Meme Selection Engine.
    
    CONTEXT: The user is chatting with you. You must reply with a meme.
    The "List of Valid Outputs" below contains the "Alt Text" (Descriptions) of the memes you have.
    Most of them are in Traditional Chinese.
    
    HISTORY:
    ${historyText}
    
    INPUT User Message (Language varies): "${text}"
    
    INSTRUCTION:
    1. Analyze the User Message.
    2. If the message is in English (e.g. "I am hungry"), mentally translate it or find the equivalent Chinese sentiment (e.g. "肚子餓").
    3. Look through the "LIST OF VALID OUTPUTS" to find the BEST match for that sentiment.
    4. CRITICAL: You MUST output the EXACT string from the list. Do not translate the output. Keep it in Chinese as listed.
    
     LIST OF VALID OUTPUTS:
    ${MEME_DATABASE.map((m) => m.alt).join("\n")}
    
    BEST MATCHING ALT TEXT (Exact Chinese string from list):
    `;

          // Call LLM
          const result = await model.generateContent({
            contents: [{ role: "user", parts: [{ text: fullPrompt }] }],
          });

          const responseText = result.response.text().trim();
          console.log("LLM Response:", responseText);

          // Find Meme (Validation)
          let selectedMeme = MEME_DATABASE.find((m) => m.alt === responseText);
          if (!selectedMeme) {
            selectedMeme = MEME_DATABASE.find(
              (m) =>
                m.alt.includes(responseText) || responseText.includes(m.alt)
            );
          }
          // Last ditch
          if (!selectedMeme) {
            selectedMeme = MEME_DATABASE.find((m) =>
              responseText.includes(m.alt)
            );
          }

          // Clear "..."
          aiMessageDiv.textContent = "";

          if (selectedMeme) {
            const img = document.createElement("img");
            img.className = "meme-image";
            img.src = selectedMeme.url;
            img.alt = `Meme: ${selectedMeme.alt}`;
            aiMessageDiv.appendChild(img);

            chatHistory.push({ role: "ai", content: selectedMeme.alt });
          } else {
            aiMessageDiv.textContent = `(No meme found for: "${responseText}")`;
            chatHistory.push({ role: "ai", content: "(No match)" });
          }
        } catch (error) {
          console.error(error);
          aiMessageDiv.textContent = "Error: " + error.message;
          if (
            error.message.includes("401") ||
            error.message.includes("API key")
          ) {
            localStorage.removeItem("MYGO_API_KEY");
            apiKey = null;
            aiMessageDiv.textContent += " (Key cleared, try again)";
          }
        }

        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function addMessage(text, role) {
        const div = document.createElement("div");
        div.className = `message ${role}-message`;
        div.textContent = text;
        chatContainer.appendChild(div);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return div;
      }

      sendBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });
    </script>
  </body>
</html>
